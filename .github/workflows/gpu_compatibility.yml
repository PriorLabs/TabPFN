# Runs GPU compatibility checks after CI completes successfully.
name: GPU Compatibility
on:
  workflow_run:
    workflows: [CI]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: gpu-compat-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test_gpu:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    name: Test on GPU
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.9"
            dependency-set: lowest-direct
          - python-version: "3.14"
            dependency-set: highest
    runs-on: ubuntu-22.04-4core-gpu
    env:
      TABPFN_MODEL_CACHE_DIR: ${{ github.workspace }}/model_cache
      HF_TOKEN: ${{ vars.TABPFN_2_5_HF_TOKEN }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group ci --resolution ${{ matrix.dependency-set }}

      - name: "Check for forbidden licenses"
        shell: bash
        run: |
          uv run --no-sync licensecheck \
            --requirements-paths pyproject.toml \
            --show-only-failing \
            -0

      - name: Restore model cache
        id: restore-model-cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ github.workspace }}/model_cache
          key: model-cache-${{ hashFiles('model_cache/**') }}
          restore-keys: |
            model-cache-
          enableCrossOsArchive: true

      - name: Download models from Hugging Face
        run: uv run --no-sync python scripts/download_all_models.py

      - name: Save model cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ github.workspace }}/model_cache
          key: model-cache-${{ hashFiles('model_cache/**') }}
          enableCrossOsArchive: true

      - name: Run Tests
        run: uv run --no-sync pytest tests/
