Refactored preprocessing-related code part 2
